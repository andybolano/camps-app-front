<div class="container-fluid mt-4">
  <div class="row">
    <div class="col-12 mb-4">
      <h2>Calificar Evento - Todos los Clubes</h2>
      <h5 *ngIf="event" class="text-muted">{{ event.name }}</h5>
      <a class="text-decoration-none" (click)="goBack()">
        <i class="bi bi-arrow-left"></i> Volver a Eventos
      </a>
    </div>

    <div *ngIf="isLoading" class="col-12 text-center my-5">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
    </div>

    <div *ngIf="errorMessage" class="col-12">
      <div class="alert alert-danger">
        {{ errorMessage }}
      </div>
    </div>

    <div *ngIf="successMessage" class="col-12">
      <div class="alert alert-success">
        {{ successMessage }}
      </div>
    </div>

    <!-- Formulario de calificación masiva -->
    <div *ngIf="!isLoading && event && bulkScoringForm" class="col-12">
      <form [formGroup]="bulkScoringForm" (ngSubmit)="onSubmit()">
        
        <!-- Información del evento -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">Información del Evento</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <p><strong>Nombre:</strong> {{ event.name }}</p>
                <p><strong>Tipo:</strong> {{ event.type === 'REGULAR' ? 'Regular' : 'Basado en Características' }}</p>
              </div>
              <div class="col-md-6">
                <p><strong>Puntaje Máximo:</strong> {{ event.maxScore || 100 }}</p>
                <p *ngIf="event.description"><strong>Descripción:</strong> {{ event.description }}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Tabla de calificaciones para eventos regulares -->
        <div class="card mb-4" *ngIf="event.type === 'REGULAR' && event.items && event.items.length > 0">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Calificaciones por Club</h5>
            <button 
              type="button" 
              class="btn btn-outline-primary btn-sm"
              (click)="updateRankingOrder()"
              title="Actualizar orden por ranking">
              <i class="bi bi-arrow-repeat"></i> Actualizar Ranking
            </button>
          </div>
          <div class="card-body">
            <!-- Alerta de validación -->
            <div *ngIf="hasAnyClubExceeded()" class="alert alert-warning mb-3">
              <h6><i class="bi bi-exclamation-triangle"></i> Atención</h6>
              <p class="mb-0">Algunos clubes tienen puntajes que exceden el máximo permitido ({{ event.maxScore }}). 
                Corrígelos antes de guardar las calificaciones.</p>
            </div>

            <div class="table-responsive">
              <table class="table table-bordered table-hover">
                <thead class="table-light">
                  <tr>
                    <th style="width: 60px;" class="text-center">Pos.</th>
                    <th style="min-width: 150px;">Club</th>
                    <th *ngFor="let item of event.items" class="text-center" style="min-width: 100px;">
                      {{ item.name }}
                    </th>
                    <th class="text-center bg-info text-white" style="min-width: 120px;">Total</th>
                  </tr>
                </thead>
                <tbody formArrayName="clubs">
                  <tr *ngFor="let clubIndex of sortedClubIndices; trackBy: trackByClubIndex" 
                      [formGroupName]="clubIndex"
                      [class.table-danger]="isClubTotalExceeded(clubIndex)">
                    <td class="text-center align-middle">
                      <span class="badge rounded-pill" [ngClass]="getRankingBadgeClass(clubIndex)">
                        {{ getClubRanking(clubIndex) }}
                      </span>
                    </td>
                    <td class="fw-bold align-middle">
                      {{ clubsFormArray.at(clubIndex).get('clubName')?.value }}
                      <div *ngIf="isClubTotalExceeded(clubIndex)" class="text-danger small">
                        <i class="bi bi-exclamation-triangle"></i> Puntaje excedido
                      </div>
                    </td>
                    <td *ngFor="let item of event.items" formGroupName="scores">
                      <input
                        type="number"
                        class="form-control form-control-sm text-center"
                        [formControlName]="item.id!.toString()"
                        min="0"
                        [max]="event.maxScore || 100"
                        step="0.1"
                        [class.is-invalid]="
                          clubsFormArray.at(clubIndex)?.get('scores')?.get(item.id!.toString())?.invalid &&
                          clubsFormArray.at(clubIndex)?.get('scores')?.get(item.id!.toString())?.touched ||
                          isClubTotalExceeded(clubIndex)
                        "
                      />
                    </td>
                    <td class="text-center align-middle">
                      <span class="badge fs-6" [ngClass]="isClubTotalExceeded(clubIndex) ? 'bg-danger' : 'bg-success'">
                        {{ calculateClubTotal(clubIndex) }}
                      </span>
                      <div *ngIf="isClubTotalExceeded(clubIndex)" class="text-danger small mt-1">
                        Máx: {{ event.maxScore }}
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Tabla de calificaciones para eventos basados en miembros -->
        <div class="card mb-4" *ngIf="event.type === 'MEMBER_BASED' && event.memberBasedItems && event.memberBasedItems.length > 0">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Calificaciones Basadas en Características</h5>
            <button 
              type="button" 
              class="btn btn-outline-primary btn-sm"
              (click)="updateRankingOrder()"
              title="Actualizar orden por ranking">
              <i class="bi bi-arrow-repeat"></i> Actualizar Ranking
            </button>
          </div>
          <div class="card-body">
            <div class="alert alert-info">
              <h6>Instrucciones:</h6>
              <p class="mb-0">Para cada club e ítem, indique el número de miembros que cumplen la característica y el total de miembros con esa característica.</p>
            </div>
            
            <div *ngFor="let item of event.memberBasedItems; let itemIndex = index" class="mb-5">
              <h6 class="border-bottom pb-2">{{ item.name }} <small class="text-muted">({{ item.percentage }}%)</small></h6>
              
              <div class="table-responsive">
                <table class="table table-bordered table-sm">
                  <thead class="table-secondary">
                    <tr>
                      <th style="width: 60px;" class="text-center">Pos.</th>
                      <th style="min-width: 150px;">Club</th>
                      <th class="text-center">Miembros que cumplen</th>
                      <th class="text-center">Total con característica</th>
                      <th class="text-center">Porcentaje</th>
                    </tr>
                  </thead>
                  <tbody formArrayName="clubs">
                    <tr *ngFor="let clubIndex of sortedClubIndices; trackBy: trackByClubIndex" [formGroupName]="clubIndex">
                      <td class="text-center align-middle">
                        <span class="badge rounded-pill" [ngClass]="getRankingBadgeClass(clubIndex)">
                          {{ getClubRanking(clubIndex) }}
                        </span>
                      </td>
                      <td class="fw-bold align-middle">
                        {{ clubsFormArray.at(clubIndex).get('clubName')?.value }}
                      </td>
                      <td formGroupName="memberBasedScores">
                        <div [formGroupName]="item.id!.toString()">
                          <input
                            type="number"
                            class="form-control form-control-sm text-center"
                            formControlName="matchCount"
                            min="0"
                            step="1"
                          />
                        </div>
                      </td>
                      <td formGroupName="memberBasedScores">
                        <div [formGroupName]="item.id!.toString()">
                          <input
                            type="number"
                            class="form-control form-control-sm text-center"
                            formControlName="totalWithCharacteristic"
                            min="0"
                            step="1"
                          />
                        </div>
                      </td>
                      <td class="text-center align-middle">
                        <ng-container formGroupName="memberBasedScores">
                          <div [formGroupName]="item.id!.toString()">
                            <span class="badge bg-info">
                              {{ getItemPercentage(clubIndex, item.id!) }}%
                            </span>
                          </div>
                        </ng-container>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Resumen de totales -->
            <div class="table-responsive">
              <table class="table table-bordered">
                <thead class="table-primary">
                  <tr>
                    <th style="width: 60px;" class="text-center">Pos.</th>
                    <th>Club</th>
                    <th class="text-center">Puntuación Final</th>
                  </tr>
                </thead>
                <tbody formArrayName="clubs">
                  <tr *ngFor="let clubIndex of sortedClubIndices; trackBy: trackByClubIndex" [formGroupName]="clubIndex">
                    <td class="text-center align-middle">
                      <span class="badge rounded-pill" [ngClass]="getRankingBadgeClass(clubIndex)">
                        {{ getClubRanking(clubIndex) }}
                      </span>
                    </td>
                    <td class="fw-bold">
                      {{ clubsFormArray.at(clubIndex).get('clubName')?.value }}
                    </td>
                    <td class="text-center">
                      <span class="badge bg-success fs-6">
                        {{ calculateClubTotal(clubIndex) }}
                      </span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Botones de acción -->
        <div class="d-flex justify-content-end gap-2 mb-4" *ngIf="event && ((event.type === 'REGULAR' && event.items && event.items.length > 0) || (event.type === 'MEMBER_BASED' && event.memberBasedItems && event.memberBasedItems.length > 0))">
          <button type="button" class="btn btn-secondary" (click)="goBack()">
            Cancelar
          </button>
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="bulkScoringForm.invalid || isLoading || hasAnyClubExceeded()"
          >
            <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2"></span>
            Guardar Todas las Calificaciones
          </button>
        </div>
      </form>

      <!-- Mensaje si no hay ítems para calificar -->
      <div
        *ngIf="event && (!event.items || event.items.length === 0) && (!event.memberBasedItems || event.memberBasedItems.length === 0)"
        class="alert alert-warning"
      >
        Este evento no tiene ítems de calificación definidos. Primero debe
        agregar ítems en la planilla de calificación del evento.
      </div>
    </div>
  </div>
</div>